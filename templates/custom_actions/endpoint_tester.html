<!--
Template: endpoint_tester.html
Purpose: Provides an interactive UI for testing custom action API endpoints.

Expected Context Variables:
  - custom_action: CustomAction object with API schema and configuration
  - operations: List of APIOperationDetails objects with the following structure:
      Each operation object contains:
      - operation_id (str): Unique identifier for the operation (e.g., "get_weather")
      - method (str): HTTP method (GET, POST, PUT, DELETE, etc.)
      - path (str): API endpoint path (e.g., "/weather")
      - description (str): Human-readable operation description
      - parameters (list): List of parameter objects, each containing:
          - name (str): Parameter name
          - required (bool): Whether the parameter is required
          - description (str): Parameter description
          - schema_type (str): Data type (string, integer, number, boolean)
          - default (any): Default value for the parameter
  - operations_data (dict): Mapping of operation_id to initial parameter values
      Structure: {operation_id: {param_name: param_value, ...}, ...}
-->

{% extends "web/app/app_base.html" %}
{% load static %}

{% block breadcrumbs %}
  <div class="text-sm breadcrumbs" aria-label="breadcrumbs">
    <ul>
      <li><a href="{% url 'custom_actions:edit' request.team.slug custom_action.id %}">{{ custom_action.name }}</a></li>
      <li class="pg-breadcrumb-active" aria-current="page">Test Endpoints</li>
    </ul>
  </div>
{% endblock breadcrumbs %}

{% block app %}
  <div class="max-w-4xl mx-auto" id="endpoint-tester">
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-3xl font-bold">Test Endpoints</h1>
    </div>

    {% if not operations %}
      <div class="alert alert-info">
        <p>No endpoints available for this custom action.</p>
      </div>
    {% else %}
      <div class="space-y-6" x-data="endpointTester()">

        {% for operation in operations %}
          <div class="card bg-base-100 shadow-md border border-base-300"
               x-data="{ opId: '{{ operation.operation_id }}' }">
            <div class="card-body">
              <!-- Endpoint Header -->
              <div class="flex items-start justify-between mb-4">
                <div>
                  <h2 class="card-title text-lg">
                    <span class="badge"
                          :class="getMethodBadgeClass('{{ operation.method }}')">
                      {{ operation.method|upper }}
                    </span>
                    <span class="font-mono text-sm break-all">{{ operation.path }}</span>
                  </h2>
                  {% if operation.description %}
                    <p class="text-sm text-gray-600 mt-1">{{ operation.description }}</p>
                  {% endif %}
                </div>
              </div>

              <!-- Parameters Section -->
              <div class="divider my-2"></div>

              {% if operation.parameters %}
                <div class="mb-4">
                  <!-- Path Parameters Section -->
                  {% if operation.path_parameters %}
                    <div class="mb-4">
                      <label class="label font-bold">
                        <span>Path Parameters</span>
                      </label>
                      <div class="space-y-3">
                        {% for param in operation.path_parameters %}
                          <div>
                            <label class="label">
                              <span class="label-text">
                                {{ param.name }}
                                {% if param.required %}<span class="text-error">*</span>{% endif %}
                                <span class="text-base-content/70 text-xs">
                                  ({{ param.schema_type }})
                                </span>
                              </span>
                            </label>
                            <input type="text"
                                   class="input input-bordered w-full"
                                   placeholder="{{ param.name }}"
                                   x-model="operations['{{ operation.operation_id }}'].pathParams['{{ param.name }}']"
                                   {% if param.description %}title="{{ param.description }}"{% endif %} />
                            {% if param.description %}
                              <p class="text-xs text-base-content/70 mt-1">{{ param.description }}</p>
                            {% endif %}
                          </div>
                        {% endfor %}
                      </div>
                    </div>
                  {% endif %}

                  <!-- Query/Body Parameters Section -->
                  {% with non_path_params=operation.non_path_parameters %}
                    {% if non_path_params %}
                      <!-- Parameters Info -->
                      <div class="mb-4 p-3 bg-base-200 rounded-lg">
                        <p class="font-semibold mb-2">Expected Parameters:</p>
                        <div class="space-y-2">
                          {% for param in non_path_params %}
                            <div class="text-sm">
                              <span class="font-mono text-base-content">{{ param.name }}</span>
                              <span class="text-base-content/70">
                                (
                                {% if param.param_in %}{{ param.param_in }}{% if param.required or param.schema_type %}, {% endif %}{% endif %}
                                {% if param.required %}required{% if param.schema_type %}, {% endif %}{% endif %}
                                {% if param.schema_type %}{{ param.schema_type }}{% endif %}
                                )
                              </span>
                              {% if param.description %}
                                <p class="text-base-content/70 text-xs mt-1">{{ param.description }}</p>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                      </div>

                      <!-- JSON Editor -->
                      <label class="label font-bold">
                        <span>Request Parameters (JSON)</span>
                      </label>
                      <textarea class="textarea textarea-bordered mt-1 block w-full h-48"
                                id="param_{{ operation.operation_id }}_json"
                                name="param_{{ operation.operation_id }}_json"
                                x-model="operations['{{ operation.operation_id }}'].jsonInput"
                                @change="updateJsonInput('{{ operation.operation_id }}', $event.target.value)"
                                placeholder='Enter JSON data, e.g., {"key": "value"}'></textarea>
                      <div class="json-editor w-full" data-target-field="textarea[name='param_{{ operation.operation_id }}_json']" data-disable-elt="button[data-test-endpoint-id='{{ operation.operation_id }}']"></div>
                    {% endif %}
                  {% endwith %}
                </div>
              {% else %}
                <div class="alert alert-info mb-4">
                  <p>No parameters detected for this endpoint.</p>
                </div>
              {% endif %}

              <!-- Test Button -->
              <div class="flex gap-2 mb-4">
                <button type="button"
                        class="btn btn-primary btn-sm transition-opacity"
                        data-test-endpoint-id="{{ operation.operation_id }}"
                        @click="testEndpoint('{{ operation.operation_id }}', '{{ custom_action.id }}')"
                        x-bind:disabled="getOperationState('{{ operation.operation_id }}').loading"
                        :class="getOperationState('{{ operation.operation_id }}').loading ? 'opacity-60 cursor-not-allowed' : 'opacity-100'">
                  <span x-show="!getOperationState('{{ operation.operation_id }}').loading">
                    Send
                  </span>
                  <span x-show="getOperationState('{{ operation.operation_id }}').loading"
                        class="loading loading-spinner loading-xs"></span>
                </button>
              </div>

              <!-- Response Section -->
              <template x-if="getOperationState('{{ operation.operation_id }}').response">
                <div>
                  <div class="divider my-2"></div>

                  <div class="bg-base-200 rounded-lg p-4"
                       x-data="{
                         responseKeys: getResponseTableKeys(getOperationState('{{ operation.operation_id }}').response.body),
                         isUniformList: isUniformObjectList(getOperationState('{{ operation.operation_id }}').response.body),
                         isFullscreen: false
                       }">
                    <div class="flex items-center justify-between mb-3">
                      <span class="font-semibold">Response</span>
                      <div class="flex gap-2">
                        <button type="button"
                                class="btn btn-xs btn-ghost"
                                @click="isFullscreen = true"
                                title="View fullscreen">
                          <i class="fas fa-expand"></i>
                        </button>
                        <span :class="getStatusBadgeClass(getOperationState('{{ operation.operation_id }}').response.status_code)"
                              class="badge badge-lg">
                          <span x-text="getOperationState('{{ operation.operation_id }}').response.status_code"></span>
                        </span>
                      </div>
                    </div>

                    <!-- View Toggle -->
                    <template x-if="getOperationState('{{ operation.operation_id }}').response.is_json">
                      <div class="flex gap-2 mb-3">
                        <button type="button"
                                class="btn btn-xs"
                                :class="getOperationState('{{ operation.operation_id }}').viewAs === 'json' ? 'btn-active' : 'btn-ghost'"
                                @click="getOperationState('{{ operation.operation_id }}').viewAs = 'json'">
                          JSON
                        </button>
                        <template x-if="isUniformList">
                          <button type="button"
                                  class="btn btn-xs"
                                  :class="getOperationState('{{ operation.operation_id }}').viewAs === 'table' ? 'btn-active' : 'btn-ghost'"
                                  @click="getOperationState('{{ operation.operation_id }}').viewAs = 'table'">
                            Table
                          </button>
                        </template>
                      </div>
                    </template>

                    <!-- JSON View -->
                    <template x-if="getOperationState('{{ operation.operation_id }}').viewAs === 'json'">
                      <div class="bg-base-300 rounded p-3 font-mono text-xs max-h-96 overflow-y-auto">
                        <pre x-text="formatJsonResponse(getOperationState('{{ operation.operation_id }}').response.body)"></pre>
                      </div>
                    </template>

                    <!-- Table View -->
                    <template x-if="getOperationState('{{ operation.operation_id }}').viewAs === 'table'">
                      <div class="overflow-x-auto max-h-96">
                        <table class="table table-sm table-zebra">
                          <thead>
                            <tr>
                              <template x-for="key in responseKeys"
                                        :key="key">
                                <th x-text="key"></th>
                              </template>
                            </tr>
                          </thead>
                          <tbody>
                            <template x-for="(row, index) in getOperationState('{{ operation.operation_id }}').response.body"
                                      :key="index">
                              <tr>
                                <template x-for="key in responseKeys"
                                          :key="key">
                                  <td>
                                    <span x-text="formatTableCell(row[key])"></span>
                                  </td>
                                </template>
                              </tr>
                            </template>
                          </tbody>
                        </table>
                      </div>
                    </template>

                    <!-- Fullscreen Modal -->
                    <template x-if="isFullscreen">
                      <div>
                        <div class="fixed inset-0 bg-black/50 z-40" @click="isFullscreen = false"></div>
                        <div class="fixed inset-4 bg-base-100 rounded-lg shadow-xl z-50 flex flex-col">
                          <div class="flex items-center justify-between p-4 border-b border-base-300">
                            <span class="font-semibold">Response (Fullscreen)</span>
                            <button type="button"
                                    class="btn btn-ghost btn-sm"
                                    @click="isFullscreen = false"
                                    title="Exit fullscreen">
                              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                              </svg>
                            </button>
                          </div>

                          <!-- Fullscreen View Toggle -->
                          <template x-if="getOperationState('{{ operation.operation_id }}').response.is_json">
                            <div class="flex gap-2 p-4 border-b border-base-300">
                              <button type="button"
                                      class="btn btn-xs"
                                      :class="getOperationState('{{ operation.operation_id }}').viewAs === 'json' ? 'btn-active' : 'btn-ghost'"
                                      @click="getOperationState('{{ operation.operation_id }}').viewAs = 'json'">
                                JSON
                              </button>
                              <template x-if="isUniformList">
                                <button type="button"
                                        class="btn btn-xs"
                                        :class="getOperationState('{{ operation.operation_id }}').viewAs === 'table' ? 'btn-active' : 'btn-ghost'"
                                        @click="getOperationState('{{ operation.operation_id }}').viewAs = 'table'">
                                  Table
                                </button>
                              </template>
                            </div>
                          </template>

                          <div class="flex-1 overflow-auto p-4">
                            <!-- Fullscreen JSON View -->
                            <template x-if="getOperationState('{{ operation.operation_id }}').viewAs === 'json'">
                              <div class="bg-base-300 rounded p-4 font-mono text-sm h-full overflow-auto">
                                <pre x-text="formatJsonResponse(getOperationState('{{ operation.operation_id }}').response.body)"></pre>
                              </div>
                            </template>

                            <!-- Fullscreen Table View -->
                            <template x-if="getOperationState('{{ operation.operation_id }}').viewAs === 'table'">
                              <div class="overflow-auto h-full">
                                <table class="table table-sm table-zebra w-full">
                                  <thead>
                                    <tr>
                                      <template x-for="key in responseKeys"
                                                :key="key">
                                        <th x-text="key"></th>
                                      </template>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    <template x-for="(row, index) in getOperationState('{{ operation.operation_id }}').response.body"
                                              :key="index">
                                      <tr>
                                        <template x-for="key in responseKeys"
                                                  :key="key">
                                          <td>
                                            <span x-text="formatTableCell(row[key])"></span>
                                          </td>
                                        </template>
                                      </tr>
                                    </template>
                                  </tbody>
                                </table>
                              </div>
                            </template>
                          </div>
                        </div>
                      </div>
                    </template>
                  </div>
                </div>
              </template>

              <!-- Error Section -->
              <template x-if="getOperationState('{{ operation.operation_id }}').error">
                <div>
                  <div class="divider my-2"></div>
                  <div class="alert alert-error">
                    <span x-text="getOperationState('{{ operation.operation_id }}').error"></span>
                  </div>
                </div>
              </template>
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

  {{ operations_data|json_script:"operations-data" }}
  <script src="{% static 'js/editors-bundle.js' %}"></script>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('endpointTester', () => ({
        operations: {},

        // HTTP status code ranges for badge styling
        HTTP_STATUS: {
          SUCCESS_MIN: 200,
          SUCCESS_MAX: 299,
          REDIRECT_MIN: 300,
          REDIRECT_MAX: 399,
          CLIENT_ERROR_MIN: 400,
          CLIENT_ERROR_MAX: 499,
          SERVER_ERROR_MIN: 500,
        },

        init() {
          const operationsData = JSON.parse(document.getElementById('operations-data').textContent);
          // Transform the JSON data into the format needed for Alpine.js
          for (const [operationId, data] of Object.entries(operationsData)) {
            this.operations[operationId] = {
              paramValues: data.params || {},
              pathParams: data.pathParams || {},
              jsonInput: JSON.stringify(data.params || {}, null, 2),
              response: null,
              error: null,
              loading: false,
              viewAs: 'json',
            };
          }

          // Initialize JSON editors after Alpine is ready
          this.$nextTick(() => {
            const container = document.getElementById('endpoint-tester');
            window.SiteJS.editors.initJsonEditors(container);
          });
        },

        /**
         * Safely access operation state by ID
         */
        getOperationState(operationId) {
          return this.operations[operationId] || {};
        },

          /**
           * Update a parameter value with type coercion
           */
          updateParamValue(operationId, paramName, value) {
            this.operations[operationId].paramValues[paramName] = this.coerceParameterValue(value);
          },

          /**
           * Get a parameter value from operation state
           */
          getParamValue(operationId, paramName) {
            return this.operations[operationId]?.paramValues?.[paramName] ?? '';
          },

          /**
           * Update JSON input from textarea
           */
          updateJsonInput(operationId, value) {
            this.operations[operationId].jsonInput = value;
          },

          /**
           * Parse parameter values as JSON only
           */
          coerceParameterValue(value) {
            if (value === '' || value === null || value === undefined) {
              return '';
            }

            // Parse as JSON
            try {
              return JSON.parse(value);
            } catch (e) {
              // If not valid JSON, return the raw string
              return value;
            }
          },

        /**
         * Build parameters from JSON input
         */
        buildParamsFromJson(operationId) {
          const opState = this.operations[operationId];
          const jsonInput = opState.jsonInput || '{}';

          try {
            return JSON.parse(jsonInput);
          } catch (e) {
            throw new Error(`Invalid JSON: ${e.message}`);
          }
        },

          /**
           * Get response table keys (computed once, not repeated per row)
           */
          getResponseTableKeys(responseBody) {
            if (!Array.isArray(responseBody) || responseBody.length === 0) {
              return [];
            }

            const firstItem = responseBody[0];
            if (typeof firstItem !== 'object' || firstItem === null || Array.isArray(firstItem)) {
              return [];
            }

            return Object.keys(firstItem);
          },

        async testEndpoint(operationId, customActionId) {
          const opState = this.operations[operationId];
          opState.loading = true;
          opState.error = null;
          opState.response = null;

            try {
              // Build params from JSON input
              let params;
              try {
                params = this.buildParamsFromJson(operationId);
              } catch (jsonError) {
                throw new Error(jsonError.message);
              }

              // Get path parameters
              const pathParams = opState.pathParams || {};

              // Make request to server
              const response = await fetch(
                "{% url 'custom_actions:test_endpoint' custom_action.team.slug custom_action.id %}",
                {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                                   document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1] || '',
                  },
                  body: JSON.stringify({
                    operation_id: operationId,
                    params: params,
                    path_params: pathParams,
                  }),
                }
              );

              let data;
              const raw = await response.text();
              try {
                data = JSON.parse(raw);
              } catch (e) {
                // If response is not JSON (e.g., HTML error page), use the raw text
                throw new Error(`Server error: ${response.status} - ${raw.substring(0, 200)}`);
              }

              if (!response.ok) {
                throw new Error(data.error || `Request failed with status ${response.status}`);
              }

              opState.response = data;
              opState.error = null;
            } catch (error) {
              console.error('Test endpoint error:', error);
              opState.error = error.message;
              opState.response = null;
            } finally {
              opState.loading = false;
            }
          },

          getMethodBadgeClass(method) {
            const classes = {
              'get': 'badge-info',
              'post': 'badge-success',
              'put': 'badge-warning',
              'patch': 'badge-warning',
              'delete': 'badge-error',
            };
            return classes[method.toLowerCase()] || 'badge-secondary';
          },

        getStatusBadgeClass(statusCode) {
          if (statusCode >= this.HTTP_STATUS.SUCCESS_MIN && statusCode <= this.HTTP_STATUS.SUCCESS_MAX) {
            return 'badge-success';
          }
          if (statusCode >= this.HTTP_STATUS.REDIRECT_MIN && statusCode <= this.HTTP_STATUS.REDIRECT_MAX) {
            return 'badge-info';
          }
          if (statusCode >= this.HTTP_STATUS.CLIENT_ERROR_MIN && statusCode <= this.HTTP_STATUS.CLIENT_ERROR_MAX) {
            return 'badge-warning';
          }
          if (statusCode >= this.HTTP_STATUS.SERVER_ERROR_MIN) {
            return 'badge-error';
          }
          return 'badge-secondary';
        },

          /**
           * Validate that response body is an array of uniform objects
           * with defensive checks for response structure
           */
          isUniformObjectList(data) {
            // Defensive check: ensure data exists and is an array
            if (!Array.isArray(data) || data.length === 0) {
              return false;
            }

            // Check if first element is an object (not null, not array)
            if (typeof data[0] !== 'object' || data[0] === null || Array.isArray(data[0])) {
              return false;
            }

            // Get keys from first object
            const firstKeys = Object.keys(data[0]).sort();

            // Check if all objects have the same keys
            return data.every(item => {
              if (typeof item !== 'object' || item === null || Array.isArray(item)) {
                return false;
              }
              const itemKeys = Object.keys(item).sort();
              return itemKeys.length === firstKeys.length && itemKeys.every((key, idx) => key === firstKeys[idx]);
            });
          },

          formatTableCell(value) {
            // Format cell value for table display
            if (value === null || value === undefined) {
              return '';
            }
            if (typeof value === 'object') {
              return JSON.stringify(value);
            }
            if (typeof value === 'boolean') {
              return value ? 'true' : 'false';
            }
            return String(value);
          },

          formatJsonResponse(body) {
            // Handle response body that might be a string or object
            if (typeof body === 'string') {
              // Try to parse as JSON, return as-is if it fails
              try {
                return JSON.stringify(JSON.parse(body), null, 2);
              } catch (e) {
                // If parsing fails, return the string as-is
                return body;
              }
            }
            // If it's already an object, stringify it
            return JSON.stringify(body, null, 2);
          },
      }));
    });
  </script>
{% endblock app %}
