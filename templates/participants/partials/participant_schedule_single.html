<div class="mb-3" id="schedule_{{ schedule.external_id }}">
  <h3 class="text-lg font-semibold px-3 mt-2">{{ schedule.name }}</h3>
  <div class="grid grid-cols-2 p-3">
    <div><p>{{ schedule.prompt }}</p></div>
    <div class="flex justify-between">
      <div>
        {% if schedule.repetitions %}
          <p class="text-sm">
            Every {{ schedule.frequency }} {{ schedule.time_period }}, {{ schedule.repetitions }} times
            {% if schedule.is_complete %}
              (Completed).
            {% elif schedule.is_cancelled %}
              (Cancelled).
            {% else %}
              ({{ schedule.triggers_remaining }} left).
            {% endif %}
          </p>
          {% if not schedule.is_complete %}
            <p class="text-sm">
              <span class="font-medium">Next due:</span>
              <time datetime="{{ schedule.next_trigger_date.isoformat }}"
                    title="{{ schedule.next_trigger_date.isoformat }}">
                {{ schedule.next_trigger_date|date:"DATETIME_FORMAT" }}
              </time>
            </p>
          {% endif %}
          <p class="text-sm">
            <span class="font-medium">Last triggered:</span>
            {% if schedule.last_triggered_at %}
              <time datetime="{{ schedule.last_triggered_at.isoformat }}"
                    title="{{ schedule.last_triggered_at.isoformat }}">
                {{ schedule.last_triggered_at|date:"DATETIME_FORMAT" }}
              </time>
            {% else %}
              Not yet triggered.
            {% endif %}
          </p>
        {% else %}
          <p class="text-sm">
            Once off {% if schedule.is_complete %}
              (Completed).
            {% elif schedule.is_cancelled %}
              (Cancelled).
            {% endif %}.
          </p>
          {% if schedule.is_complete %}
            <p class="text-sm">
              <span class="font-medium">Triggered on:</span>
              {% if schedule.last_triggered_at %}
                <time datetime="{{ schedule.last_triggered_at.isoformat }}"
                      title="{{ schedule.last_triggered_at.isoformat }}">
                  {{ schedule.last_triggered_at|date:"DATETIME_FORMAT" }}
                </time>
              {% else %}
                Not yet triggered.
              {% endif %}
            </p>
          {% else %}
            <p class="text-sm">
              <span class="font-medium">Due:</span>
              <time datetime="{{ schedule.next_trigger_date.isoformat }}"
                    title="{{ schedule.next_trigger_date.isoformat }}">
                {{ schedule.next_trigger_date|date:"DATETIME_FORMAT" }}
              </time>
            </p>
          {% endif %}
        {% endif %}
      </div>
      {% if schedule.attempts %}
        <details class="mt-2">
          <summary class="cursor-pointer font-semibold">
            Attempts ({{ schedule.attempts|length }})
          </summary>
          <div class="mt-2 border border-gray-200 rounded p-2 max-h-60 overflow-auto">
            <table class="table-auto w-full text-sm">
              <thead>
                <tr>
                  <th class="text-left p-1">Attempted At</th>
                  <th class="text-left p-1">Trigger #</th>
                  <th class="text-left p-1">Attempt #</th>
                  <th class="text-left p-1">Result</th>
                  <th class="text-left p-1">Log</th>
                  <th class="text-left p-1">Trace</th>
                </tr>
              </thead>
              <tbody>
                {% for attempt in schedule.attempts %}
                  <tr class="border-t border-gray-200">
                    <td class="p-1">
                      {{ attempt.attempted_at|date:"DATETIME_FORMAT" }}
                    </td>
                    <td class="p-1">{{ attempt.trigger_number }}</td>
                    <td class="p-1">{{ attempt.attempt_number }}</td>
                    <td class="p-1">{{ attempt.attempt_result }}</td>
                    <td class="p-1">{{ attempt.log_message|default:"—" }}</td>
                    <td class="p-1">
                      {% if attempt.trace_info %}
                            <pre class="whitespace-pre-wrap">{{ attempt.trace_info|json_script:"traceinfo" }}</pre>
                      {% else %}
                        —
                      {% endif %}
                    </td>
                  </tr>
                {% empty %}
                  <tr>
                    <td colspan="6" class="p-1">No attempts yet.</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </details>
      {% endif %}

          <!-- Cancel button -->
      {% if perms.experiments.change_participant %}
        <div>
          <button
            class="btn btn-sm btn-ghost tooltip"
            data-tip="Cancel this schedule"
            {% if schedule.is_cancelled or schedule.is_complete %}disabled{% endif %}
            hx-post="{% url 'participants:cancel_schedule' request.team.slug participant_id schedule.external_id %}"
            hx-confirm="Are you sure you want to cancel this schedule?"
            hx-target="#schedule_{{ schedule.external_id }}"
            hx-swap="outerHTML"
          >
            <i class="fa-solid fa-ban"></i>
          </button>
        </div>
      {% endif %}
    </div>
  </div>
</div>