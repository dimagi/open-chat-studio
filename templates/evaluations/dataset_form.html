{% extends 'generic/object_form.html' %}
{% load form_tags %}
{% load i18n %}
{% block form %}
  {{ form.non_field_errors }}
  {% render_form_fields form %}
  <div x-data="messageBuilder()" x-init="init()">
    <input type="hidden" name="messages_json" x-model="jsonString">
    <div class="w-full mt-4">
      <div x-data="{ showClone: false }" class="border p-4 bg-base-100 rounded-sm shadow-sm mb-2">
        <button
          type="button"
          class="flex justify-between items-center w-full text-left"
          @click="showClone = !showClone"
        >
          <h3 class="text-md">Clone messages from a previous session</h3>
          <i :class="showClone ? 'fa fa-chevron-up' : 'fa fa-chevron-down'" class="mr-2 float-right" aria-hidden="true"></i>
        </button>

        <div class="mt-4" x-show="showClone">
          <div id="sessions-table"
               hx-get="{% url 'evaluations:dataset_sessions_list' request.team.slug %}"
               hx-trigger="load"
               hx-target="this"
               hx-swap="innerHTML">
          </div>
        </div>
      </div>
    </div>

    <div class="flex items-center justify-between mt-2">
      <h2 class="font-bold text-lg">Messages</h2>
      <div class="tooltip" data-tip="Add message to the dataset">
        <button class="btn btn-primary btn-xs" type="button" onclick="new_message_modal.showModal()">
          <i class="fa-solid fa-plus"></i> Add Message
        </button>
      </div>
    </div>
    <div x-show="messages.length === 0" class="mt-4">
      <p>Add a message to the dataset or start by cloning a session above.</p>
    </div>
    <table class="table w-full mt-4" x-show="messages.length > 0">
      <thead>
        <tr>
          <th>Human Message</th>
          <th>AI Message</th>
          <th>Context</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(msg, index) in messages" :key="index">
          <tr>
            <td x-text="msg.human.content"></td>
            <td x-text="msg.ai.content"></td>
            <td>
              <dl>
                <template x-for="(value, key) in msg.context" :key="key">
                  <div class="mb-1">
                    <dt class="font-bold" x-text="key"></dt>
                    <dd class="ml-2" x-html="value?.toString().replaceAll('\n', '<br>')"></dd>
                  </div>
                </template>
              </dl>
            </td>
            <td>
              <button class="btn btn-ghost" type="button" @click="removeMessage(index)"><i class="fa-solid fa-trash"></i></button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
    <dialog id="session_message_modal" class="modal">
      <div class="modal-box max-w-5xl w-full">
        <div class="flex items-center justify-between mt-2">
          <h3 class="text-lg font-bold">Messages</h3>
          <div class="modal-action">
            <button type="button" class="btn" @click="session_message_modal.close()">Close</button>
          </div>
        </div>
        <div id="session_message_modal_content"></div>
      </div>
    </dialog>
    <dialog id="new_message_modal" class="modal">
      <div class="modal-box">
        <h3 class="text-lg font-bold">Add Message</h3>
        <div id="new_message_form" class="form">
          <div class="fieldset w-full">
            <label class="label mt-2">
              {% trans "Human Message" %}
            </label>
            <textarea x-model="newMessage.human.content" class="w-full textarea textarea-bordered" rows="3"></textarea>
          </div>
          <div class="fieldset w-full">
            <label class="label mt-2">
              {% trans "AI Message" %}
            </label>
            <textarea x-model="newMessage.ai.content" class="w-full textarea textarea-bordered" rows="3"></textarea>
          </div>
        </div>

        <div class="modal-action">
          <button type="button" class="btn" @click="resetNewMessage(); new_message_modal.close()">Cancel</button>
          <button type="button" class="btn btn-primary" @click="addMessage(); new_message_modal.close()" :disabled="!(newMessage.ai.content.trim() || newMessage.human.content.trim())">Add</button>
        </div>
      </div>
    </dialog>
  </div>
{% endblock %}

{% block page_js %}
  <script>
    function messageBuilder() {
      return {
        messages: [],
        newMessage: {human: { content: "", id: ""}, ai: { content: "", id: ""}, context: {}},
        jsonString: "[]",

        init() {
          this.updateJson();
        },

        addMessage() {
          this.messages.push({ ...this.newMessage });
          this.resetNewMessage();
          this.updateJson();
        },

        resetNewMessage() {
          this.newMessage = {human: { content: "", id: ""}, ai: { content: "", id: ""}};
        },

        removeMessage(index) {
          this.messages.splice(index, 1);
          this.updateJson();
        },

        updateJson() {
          this.jsonString = JSON.stringify(this.messages);
        },

        cloneMessagesFromSessionUrl(sessionId) {
          if (this.messages.length > 0 && !confirm("Replace existing messages?")) return;
          const urlTemplate = "{% url 'evaluations:session_messages_json' request.team.slug 'SESSION_ID' %}";
          const url = urlTemplate.replace('SESSION_ID', sessionId);
          fetch(url)
            .then(response => {
              if (!response.ok) throw new Error("Failed to fetch messages.");
              return response.json();
            })
            .then(data => {
              if (!Array.isArray(data)) return;
              this.messages = data;
              this.updateJson();
            })
            .catch(error => {
              alertify.error(`There was an error: "${error}"`);
              console.error(error);
            });
        }
      }
    }
  </script>
{% endblock %}
