{% extends 'generic/object_form.html' %}
{% load form_tags %}
{% block form %}
  {{ form.non_field_errors }}
  {% render_form_fields form %}
  <div x-data="messageBuilder()" x-init="init()">
    <input type="hidden" name="messages_json" x-model="jsonString">
    <div class="w-full mt-4" x-show="messages.length === 0">
      <div x-data="{ showClone: false }" class="border rounded-lg p-4 bg-base-100">
        <button
          type="button"
          class="flex justify-between items-center w-full text-left"
          @click="showClone = !showClone"
        >
          <h3 class="text-md font-bold">Clone messages from a previous session</h3>
          <i :class="showClone ? 'fa fa-chevron-up' : 'fa fa-chevron-down'" class="mr-2 float-right" aria-hidden="true"></i>
        </button>

        <div x-show="showClone">
          <div id="sessions-table"
               hx-get="{% url 'evaluations:dataset_sessions_list' request.team.slug %}"
               hx-trigger="load"
               hx-target="this"
               hx-swap="innerHTML">
          </div>
        </div>
      </div>
    </div>

    <div class="flex items-center justify-between mt-2">
      <h2 class="font-bold text-lg">Messages</h2>
      <div class="tooltip" data-tip="Add message to the dataset">
        <button class="btn btn-primary btn-xs" type="button" onclick="new_message_modal.showModal()">
          <i class="fa-solid fa-plus"></i> Add Message
        </button>
      </div>
    </div>
    <table class="table w-full mt-4" x-show="messages.length > 0">
      <thead>
        <tr>
          <th>Type</th>
          <th>Content</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        <template x-for="(msg, index) in messages" :key="index">
          <tr>
            <td x-text="msg.message_type"></td>
            <td x-text="msg.content"></td>
            <td>
              <button class="btn btn-ghost" type="button" @click="removeMessage(index)"><i class="fa-solid fa-trash"></i></button>
            </td>
          </tr>
        </template>
      </tbody>
    </table>
    <dialog id="session_message_modal" class="modal">
      <div class="modal-box max-w-5xl w-full">
        <div class="flex items-center justify-between mt-2">
          <h3 class="text-lg font-bold">Messages</h3>
          <div class="modal-action">
            <button type="button" class="btn" @click="session_message_modal.close()">Close</button>
          </div>
        </div>
        <div id="session_message_modal_content"></div>
      </div>
    </dialog>
    <dialog id="new_message_modal" class="modal">
      <div class="modal-box">
        <h3 class="text-lg font-bold">Add Message</h3>
        <div id="new_message_form" class="form">
          <div class="fieldset w-full">
            <label class="label mt-2">
              {{ new_message_form.message_type.label }}
            </label>
            <select x-model="newMessage.message_type" class="select w-full">
              {% for val, label in new_message_form.fields.message_type.choices %}
                <option value="{{ val }}">{{ label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="fieldset w-full">
            <label class="label mt-2">{{ new_message_form.content.label }}</label>
            <textarea x-model="newMessage.content" class="w-full textarea textarea-bordered" rows="3"></textarea>
          </div>
        </div>

        <div class="modal-action">
          <button type="button" class="btn" @click="resetNewMessage(); new_message_modal.close()">Cancel</button>
          <button type="button" class="btn btn-primary" @click="addMessage(); new_message_modal.close()" :disabled="!(newMessage.content.trim() && newMessage.message_type)">Add</button>
        </div>
      </div>
    </dialog>
  </div>
{% endblock %}

{% block page_js %}
  <script>
    function messageBuilder() {
      return {
        messages: [],
        newMessage: { id: null, message_type: null, content: "" },
        jsonString: "[]",

        init() {
          this.updateJson();
        },

        addMessage() {
          if (!this.newMessage.content.trim()) return;
          this.messages.push({ ...this.newMessage });
          this.resetNewMessage();
          this.updateJson();
        },

        resetNewMessage() {
          this.newMessage = { id: null, message_type: null, content: "" };
        },

        removeMessage(index) {
          this.messages.splice(index, 1);
          this.updateJson();
        },

        updateJson() {
          this.jsonString = JSON.stringify(this.messages);
        },

        cloneMessagesFromSessionUrl(sessionId) {
          if (this.messages.length > 0 && !confirm("Replace existing messages?")) return;
          const urlTemplate = "{% url 'evaluations:session_messages_json' request.team.slug 'SESSION_ID' %}";
          const url = urlTemplate.replace('SESSION_ID', sessionId);
          fetch(url)
            .then(response => {
              if (!response.ok) throw new Error("Failed to fetch messages.");
              return response.json();
            })
            .then(data => {
              if (!Array.isArray(data)) return;
              this.messages = data.map(m => ({
                id: m.id,
                message_type: m.message_type,
                content: m.content,
              }));
              this.updateJson();
            })
            .catch(error => {
              alertify.error(`There was an error: "${error}"`);
              console.error(error);
            });
        }
      }
    }
  </script>
{% endblock %}
