{% extends "web/app/app_base.html" %}
{% load static %}
{% load form_tags %}
{% load i18n %}
{% load chat_tags %}
{% load json_tags %}

{% block app %}
  <div class="app-card max-w-full mx-auto" x-data="datasetMessageSelector()">
    <div class="flex">
      <div class="flex-1">
        <h1 class="pg-title">Create Dataset</h1>
      </div>
    </div>
    
    <form method="post" class="my-2">
      {% csrf_token %}
      {{ form.non_field_errors }}
      {% render_form_fields form "dataset" "message_ids" %}
      <span class="text-sm">OR</span>
      {% render_form_fields form "new_dataset_name" %}
      <button type="submit" class="btn btn-primary mt-2">
        Submit
      </button>
    </form>

    {% if messages %}
      <div class="mt-6">
        <p class="text mb-4">
          {% trans "Select the human messages you want to include in the dataset. Each selected human message will be paired with its subsequent AI response." %}
        </p>
        <div class="border rounded-lg">
          <div class="flow-root my-1 overflow-x-auto min-w-full align-middle">
            <table class="min-w-full divide-y divide-gray-300">
              <thead class="bg-base-200">
                <tr>
                  <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold">{% trans "Select" %} (<span x-text="selectedMessages.length"></span>)</th>
                  <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold">{% trans "Message" %}</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200">
              {% for message in messages %}
                <tr class="{% if message.is_ai_message %}bg-sky-100/40 dark:bg-sky-950/40{% endif %}">
                  <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium">
                    {% if message.is_human_message and message.next_message_is_ai %}
                      <input 
                        type="checkbox" 
                        value="{{ message.id }}" 
                        class="checkbox checkbox-primary message-checkbox"
                        x-model="selectedMessages"
                        data-message-id="{{ message.id }}"
                      />
                    {% endif %}
                  </td>
                  <td class="px-3 py-2 text-sm flex flex-col gap-2">
                    <div class="flex place-items-center">
                      {% if message.is_ai_message %}
                        {% include "experiments/chat/components/system_icon.html" %}
                      {% else %}
                        {% include "experiments/chat/components/user_icon.html" %}
                      {% endif %}
                      <div class="grow">
                        <div class="message-contents">
                          <p>{{ message.content|render_markdown }}</p>
                        </div>

                        <div class="flex flex-col">
                          {% for file in message.get_attached_files %}
                            <div class="inline text-sm p-1">
                              <a href="{% url "experiments:download_file" request.team.slug experiment_session.id file.id %}" target="_blank" class="link link-primary">
                                <i class="fa-solid fa-file fa-sm mr-1"></i>{{ file.name }}
                              </a>
                              ({{ file.display_size }})
                              {% if file.is_image %}
                                <div class="mt-1" x-data="{ showImage: false }">
                                  <button
                                    @click="showImage = !showImage"
                                    class="btn btn-ghost btn-xs"
                                    :class="showImage ? 'text-primary' : 'text-gray-500'">
                                    <i class="fa-solid fa-image fa-sm mr-1"></i>
                                    <span x-text="showImage ? 'Hide Image' : 'Show Image'"></span>
                                  </button>
                                  <div
                                    x-show="showImage"
                                    x-transition
                                    class="mt-2"
                                    hx-get="{% url 'experiments:get_image_html' request.team.slug experiment_session.id file.id %}"
                                    hx-trigger="intersect once"
                                    hx-swap="innerHTML">
                                    <div class="flex items-center gap-2 text-xs text-gray-500">
                                      <i class="fa-solid fa-spinner fa-spin"></i>
                                      Loading image...
                                    </div>
                                  </div>
                                </div>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>
                        <div class="mt-2 pg-text-muted flex justify-between items-center gap-2">
                          <div>
                            <i class="fa-solid fa-clock mr-1"></i>
                            <time datetime="{{ message.created_at.isoformat }}" title="{{ message.created_at.isoformat }}">
                              {{ message.created_at|date:"DATETIME_FORMAT" }}
                            </time>
                          </div>
                          {% include "experiments/chat/components/trace_icons.html" with trace_infos=message.trace_info %}
                          {% if perms.annotations.add_usercomment %}
                            <div class="grow">
                              {% include "annotations/tag_ui.html" with object=message allow_edit=False %}
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </td>
                </tr>
              {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    {% else %}
      <div class="mt-6 p-4 bg-gray-50 rounded-lg">
        <p class="text-sm text-gray-600">{% trans "No messages found for this session." %}</p>
      </div>
    {% endif %}
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('datasetMessageSelector', () => ({
            selectedMessages: [],
            init() {
                // Initialize from form field if it has a value
                const messageIdsInput = document.querySelector('input[name="message_ids"]');
                if (messageIdsInput && messageIdsInput.value) {
                    this.selectedMessages = messageIdsInput.value.split(',').filter(id => id.trim());
                }
            },
        }))});
</script>
{% endblock app %}
