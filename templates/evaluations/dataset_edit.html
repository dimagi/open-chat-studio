{% extends "generic/object_form.html" %}
{% load i18n %}
{% load static %}

{% block page_head %}
  {{ block.super }}
  <script src="{% static 'celery_progress/celery_progress.js' %}"></script>
{% endblock page_head %}

{% block post_form %}
  <h2 class="pg-subtitle">{% trans "Dataset Messages" %}</h2>
  <div id="dataset-messages-table"
       hx-get="{% url 'evaluations:dataset_messages_table' request.team.slug object.id %}"
       hx-trigger="load, refreshTable from:body"
       hx-target="this"
       hx-swap="innerHTML">
    <div class="text-center py-4">
      <i class="fa-solid fa-spinner fa-spin"></i> {% trans "Loading messages..." %}
    </div>
  </div>

  {% include "evaluations/components/add_message_form.html" %}

  <div class="mt-8">
    <h3 class="text-lg font-medium mb-4">{% trans "Upload CSV" %}</h3>
    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
        {% trans "Upload a CSV file to update this dataset. Include an 'id' column to update existing messages, or omit it to create new messages." %}
      </p>

      <form id="csv-upload-form" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="mb-4">
          <label for="csv-file" class="block text-sm font-medium mb-2">{% trans "CSV File" %}</label>
          <input type="file"
                 id="csv-file"
                 name="csv_file"
                 accept=".csv"
                 class="file-input file-input-bordered w-full"
                 required>
        </div>

        <div class="flex gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-upload"></i> {% trans "Upload CSV" %}
          </button>
          <a href="{% url 'evaluations:dataset_download' request.team.slug object.id %}" class="btn btn-secondary">
            <i class="fa-solid fa-download"></i> {% trans "Download Template" %}
          </a>
        </div>
      </form>

      <div id="upload-status" class="mt-4 hidden">
        <div class="alert" id="upload-alert">
          <div id="upload-message"></div>
        </div>
      </div>

      <div id="progress-wrapper" class="mt-4 hidden">
        <div class="progress-wrapper">
          <div id="progress-bar" class="progress-bar h-4 bg-blue-200 dark:bg-blue-700 rounded-full overflow-hidden">
            <div class="bg-blue-600 dark:bg-blue-400 h-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
        <div id="progress-bar-message" class="mt-2 text-sm text-center">Processing CSV...</div>
      </div>
    </div>
  </div>

  <dialog id="editMessageModal" class="modal"></dialog>
{% endblock post_form %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/editors-bundle.js' %}"></script>
  <script>
    SiteJS.editors.initJsonEditors();

    // CSV upload functionality
    const uploadForm = document.getElementById('csv-upload-form');
    const uploadStatus = document.getElementById('upload-status');
    const uploadAlert = document.getElementById('upload-alert');
    const uploadMessage = document.getElementById('upload-message');
    const progressWrapper = document.getElementById('progress-wrapper');

    uploadForm.addEventListener('submit', async function(e) {
      e.preventDefault();

      const formData = new FormData(uploadForm);
      const uploadUrl = "{% url 'evaluations:dataset_upload' request.team.slug object.id %}";

      // Show progress
      uploadStatus.classList.add('hidden');
      progressWrapper.classList.remove('hidden');

      try {
        const response = await fetch(uploadUrl, {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          }
        });

        const data = await response.json();

        if (data.success && data.task_id) {
          const progressUrl = `/celery-progress/${data.task_id}/`;
          CeleryProgressBar.initProgressBar(progressUrl, {
            pollInterval: 1000,
            onSuccess: (progressBarElement, progressBarMessageElement, result) => {
              progressWrapper.classList.add('hidden');
              uploadStatus.classList.remove('hidden');

              if (result && result.success) {
                uploadAlert.className = 'alert alert-success';
                let message = `Successfully processed ${result.total_processed} rows: `;
                message += `${result.updated_count} updated, ${result.created_count} created.`;

                if (result.errors && result.errors.length > 0) {
                  message += `\n\nErrors:\n${result.errors.join('\n')}`;
                }
                uploadMessage.textContent = message;
                const tableContainer = document.getElementById('dataset-messages-table');
                if (tableContainer) {
                  const tableUrl = tableContainer.getAttribute('hx-get');
                  htmx.ajax('GET', tableUrl, {
                    target: '#dataset-messages-table',
                    swap: 'innerHTML'
                  });
                }

                uploadForm.reset();
              } else {
                uploadAlert.className = 'alert alert-error';
                uploadMessage.textContent = result?.error || 'Upload completed with errors';
              }
            },
            onError: (progressBarElement, progressBarMessageElement, excMessage) => {
              progressWrapper.classList.add('hidden');
              uploadStatus.classList.remove('hidden');
              uploadAlert.className = 'alert alert-error';
              uploadMessage.textContent = 'Error during upload: ' + excMessage;
            }
          });
        } else {
          progressWrapper.classList.add('hidden');
          uploadStatus.classList.remove('hidden');
          uploadAlert.className = 'alert alert-error';
          uploadMessage.textContent = data.error || 'An error occurred while uploading the CSV.';
        }

      } catch (error) {
        console.error('Upload error:', error);
        progressWrapper.classList.add('hidden');
        uploadStatus.classList.remove('hidden');
        uploadAlert.className = 'alert alert-error';
        uploadMessage.textContent = 'An error occurred while uploading the CSV.';
      }
    });

    document.addEventListener('htmx:afterRequest', function(event) {
      if (event.detail.xhr.status === 200 && event.detail.target.id === 'editMessageModal') {
        // Check if the response contains validation errors
        const modalBox = event.detail.target.querySelector('.modal-box');
        const hasErrors = modalBox && modalBox.hasAttribute('data-has-errors');

        if (hasErrors) {
          // Don't close modal or refresh table if there are validation errors
          return;
        }

        if (event.detail.target.id === 'editMessageModal') {
          document.getElementById('editMessageModal').close();
        }
        htmx.trigger(document.body, 'refreshTable');
      }
    });
  </script>
{% endblock page_js %}
