{% extends "generic/object_form.html" %}
{% load django_tables2 form_tags i18n static %}

{% block page_head %}
  {{ block.super }}
  <script src="{% static 'celery_progress/celery_progress.js' %}"></script>
{% endblock page_head %}

{% block form %}
  {{ form.non_field_errors }}
  {% render_form_fields form "name" %}
{% endblock form %}

{% block post_form %}
  {% if object.is_processing or object.is_pending %}
    <div class="mb-6">
      <h2 class="text-lg font-semibold mb-4">{% translate "Creating Dataset Messages" %}</h2>
      <div class="progress-wrapper">
        <div id="progress-bar" class="progress-bar h-4 bg-blue-200 dark:bg-blue-700 rounded-full overflow-hidden">
        </div>
      </div>
      <div id="progress-bar-message" class="mt-2 text-sm text-center">{% translate "Waiting for task to start..." %}</div>
    </div>

    <script>
      const progressUrl = "{% url 'celery_progress:task_status' celery_job_id %}";
      CeleryProgressBar.initProgressBar(progressUrl, {
        onSuccess: () => {
          location.reload()  // Reload to show completed dataset
        },
        onProgress: (progressBarElement, progressBarMessageElement, progress) => {
          progressBarElement.style.width = progress.percent + "%";
          let description = progress.description || progress.current + ' of ' + progress.total + ' processed';
          if (progress.current === 0) {
            if (progress.pending === true) {
              progressBarMessageElement.textContent = '{% translate "Waiting for task to start..." %}';
            } else {
              progressBarMessageElement.textContent = '{% translate "Task started..." %}';
            }
          } else {
            progressBarMessageElement.textContent = description;
          }
        }
      });
    </script>
  {% else %}
    {% if object.is_failed and object.error_message %}
      <div class="alert alert-error mb-4">
        <i class="fa-solid fa-exclamation-triangle"></i>
        <div>
          <h3 class="font-bold">{% translate "Dataset Creation Failed" %}</h3>
          <p>{{ object.error_message }}</p>
          <p class="text-sm mt-2">{% translate "You can still add messages manually below." %}</p>
        </div>
      </div>
    {% endif %}
    <h2 class="pg-subtitle">{% translate "Dataset Messages" %}</h2>
    <div id="dataset-messages-table"
         hx-get="{% url 'evaluations:dataset_messages_table' request.team.slug object.id %}{% if request.GET.message_id %}?{% querystring %}{% endif %}"
         hx-trigger="load, refreshTable from:body"
         hx-target="this"
         hx-swap="innerHTML">
      <div class="text-center py-4">
        <i class="fa-solid fa-spinner fa-spin"></i> {% translate "Loading messages..." %}
      </div>
    </div>

  <div x-data="datasetModeSelector({ defaultMode: 'manual', sessionIdsFetchUrl: '{% url 'evaluations:dataset_sessions_selection_json' team.slug %}' })" x-init="init()" class="mt-6">
    <h3 class="text-lg font-semibold mb-4">{% translate "Add Messages to Dataset" %}</h3>

    <!-- Mode selection -->
    <div class="form-control mb-4">
      {{ form.mode }}
    </div>

    <div x-show="!loaded" class="text-center py-8">
      <i class="fa-solid fa-spinner fa-spin fa-2x text-primary"></i>
    </div>

    <div x-show="loaded" x-cloak>
      <!-- Clone from sessions mode -->
      <div x-show="mode === 'clone'" class="w-full mt-4">
        <form method="post" action="{% url 'evaluations:dataset_edit' request.team.slug object.id %}" x-ref="cloneForm">
          {% csrf_token %}
          <input type="hidden" name="name" value="{{ object.name }}">
          <input type="hidden" name="mode" value="clone">
          <input type="hidden" name="session_ids" x-ref="sessionIds">
          <input type="hidden" name="filtered_session_ids" x-ref="filteredSessionIds">

          <div class="p-4 bg-base-100 rounded-sm shadow-sm mb-4">
            <h4 class="text-base font-semibold mb-4">{% translate "Select Sessions to Clone Messages From" %}</h4>
            <p class="text-sm text-gray-600 mb-4">
              {% translate "Select one or more experiment sessions. All message pairs (human-AI) from the selected sessions will be added to this dataset. Duplicate messages (based on message IDs) will be automatically skipped." %}
            </p>

            <div class="mb-4">
              <div class="flex items-center justify-between">
                <div>
                  {% include "experiments/filters.html" %}
                </div>
                <div x-show="selectedSessionIds.size + filteredSessionIds.size > 0" class="text-sm font-medium ml-4">
                  <span x-text="selectedSessionIds.size + filteredSessionIds.size"></span> session<span x-show="selectedSessionIds.size + filteredSessionIds.size !== 1">s</span> selected
                  <button type="button" class="btn btn-xs btn-outline ml-2" @click="clearAllSelections()">
                    Clear
                  </button>
                </div>
              </div>
            </div>

            <div id="sessions-table" class="overflow-x-auto w-full" data-url="{% url 'evaluations:dataset_sessions_selection_list' request.team.slug %}">
              {% include "table/table_placeholder.html" %}
            </div>
          </div>

          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-plus mr-2"></i>
            {% translate "Clone Messages to Dataset" %}
          </button>
        </form>
      </div>

      <!-- Manual mode -->
      <div x-show="mode === 'manual'" class="w-full mt-4">
        {% include "evaluations/components/add_message_form.html" %}
      </div>

      <!-- CSV mode -->
      <div x-show="mode === 'csv'" class="w-full mt-4">
        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
          <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
            {% translate "Upload a CSV file to update this dataset. Include an 'id' column to update existing messages, or omit it to create new messages." %}
          </p>

          <form id="csv-upload-form" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="mb-4">
              <label for="csv-file" class="block text-sm font-medium mb-2">{% translate "CSV File" %}</label>
              <input type="file"
                     id="csv-file"
                     name="csv_file"
                     accept=".csv"
                     class="file-input file-input-bordered w-full"
                     required>
            </div>

            <div class="flex gap-2">
              <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-upload"></i> {% translate "Upload CSV" %}
              </button>
              <a href="{% url 'evaluations:dataset_download' request.team.slug object.id %}" class="btn btn-secondary">
                <i class="fa-solid fa-download"></i> {% translate "Download Template" %}
              </a>
            </div>
          </form>

          <div id="upload-status" class="mt-4 hidden">
            <div class="alert" id="upload-alert">
              <div id="upload-message"></div>
            </div>
          </div>

          <div id="progress-wrapper" class="mt-4 hidden">
            <div class="progress-wrapper">
              <div id="progress-bar" class="progress-bar h-4 bg-blue-200 dark:bg-blue-700 rounded-full overflow-hidden">
                <div class="bg-blue-600 dark:bg-blue-400 h-full transition-all duration-300" style="width: 0%"></div>
              </div>
            </div>
            <div id="progress-bar-message" class="mt-2 text-sm text-center">Processing CSV...</div>
          </div>
        </div>
      </div>

      <!-- Error messages -->
      <div x-show="errorMessages.length" class="alert alert-error mb-4 mt-4">
        <i class="fa-solid fa-exclamation-triangle"></i>
        <div>
          <template x-for="error in errorMessages || []">
            <p x-text="error"></p>
          </template>
        </div>
      </div>
    </div>
  </div>

  {% endif %}

  <dialog id="editMessageModal" class="modal"></dialog>
{% endblock post_form %}

{% block page_js %}
  {{ block.super }}
  <script src="{% static 'js/evaluations-bundle.js' %}"></script>
  <script src="{% static 'js/editors-bundle.js' %}"></script>
  <script>
    window.addEventListener('load', () => {
      SiteJS.editors.initJsonEditors();
    });

    document.addEventListener('DOMContentLoaded', function() {
      // CSV upload functionality
      const uploadForm = document.getElementById('csv-upload-form');
      const uploadStatus = document.getElementById('upload-status');
      const uploadAlert = document.getElementById('upload-alert');
      const uploadMessage = document.getElementById('upload-message');
      const progressWrapper = document.getElementById('progress-wrapper');

      uploadForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const formData = new FormData(uploadForm);
        const uploadUrl = "{% url 'evaluations:dataset_upload' request.team.slug object.id %}";

        // Show progress
        uploadStatus.classList.add('hidden');
        progressWrapper.classList.remove('hidden');

        try {
          const response = await fetch(uploadUrl, {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
          });

          const data = await response.json();

          if (data.success && data.task_id) {
            const progressUrl = `/celery-progress/${data.task_id}/`;
            CeleryProgressBar.initProgressBar(progressUrl, {
              pollInterval: 1000,
              onSuccess: (progressBarElement, progressBarMessageElement, result) => {
                progressWrapper.classList.add('hidden');
                uploadStatus.classList.remove('hidden');

                if (result && result.success) {
                  uploadAlert.className = 'alert alert-success';
                  let message = `Successfully processed ${result.total_processed} rows: `;
                  message += `${result.updated_count} updated, ${result.created_count} created.`;

                  if (result.errors && result.errors.length > 0) {
                    message += `\n\nErrors:\n${result.errors.join('\n')}`;
                  }
                  uploadMessage.textContent = message;
                  const tableContainer = document.getElementById('dataset-messages-table');
                  if (tableContainer) {
                    const tableUrl = tableContainer.getAttribute('hx-get');
                    htmx.ajax('GET', tableUrl, {
                      target: '#dataset-messages-table',
                      swap: 'innerHTML'
                    });
                  }

                  uploadForm.reset();
                } else {
                  uploadAlert.className = 'alert alert-error';
                  uploadMessage.textContent = result?.error || 'Upload completed with errors';
                }
              },
              onError: (progressBarElement, progressBarMessageElement, excMessage) => {
                progressWrapper.classList.add('hidden');
                uploadStatus.classList.remove('hidden');
                uploadAlert.className = 'alert alert-error';
                uploadMessage.textContent = 'Error during upload: ' + excMessage;
              }
            });
          } else {
            progressWrapper.classList.add('hidden');
            uploadStatus.classList.remove('hidden');
            uploadAlert.className = 'alert alert-error';
            uploadMessage.textContent = data.error || 'An error occurred while uploading the CSV.';
          }

        } catch (error) {
          console.error('Upload error:', error);
          progressWrapper.classList.add('hidden');
          uploadStatus.classList.remove('hidden');
          uploadAlert.className = 'alert alert-error';
          uploadMessage.textContent = 'An error occurred while uploading the CSV.';
        }
      });

      document.addEventListener('htmx:afterRequest', function(event) {
        if (event.detail.xhr.status === 200 && event.detail.target.id === 'editMessageModal') {
          // Check if the response contains validation errors
          const modalBox = event.detail.target.querySelector('.modal-box');
          if (!modalBox) {
            return;
          }
          const hasErrors = modalBox.hasAttribute('data-has-errors');
          if (hasErrors) {
            // Don't close modal or refresh table if there are validation errors
            return;
          }

          document.getElementById('editMessageModal').close();
          htmx.trigger(document.body, 'refreshTable');
        }
        if (event.detail.xhr.status === 200 && event.detail.target.id.startsWith('record-')) {
          document.getElementById('editMessageModal')?.close();
        }
      });
    });
  </script>
{% endblock page_js %}
