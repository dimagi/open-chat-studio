{% load chat_tags json_tags %}

<!-- 2-Column Input/Output Layout -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- Input Column -->
    <div class="flex flex-col gap-6">
        <div class="card bg-base-100 shadow-md">
            <div class="card-header border-b border-base-200 px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-base-content">User Query</h3>
                    {% if trace.input_message.get_absolute_url %}
                        <a href="{{ trace.input_message.get_absolute_url }}" class="btn btn-sm btn-ghost" title="View in session">
                            <i class="fa-solid fa-arrow-up-right-from-square"></i>
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-6">
                {% if trace.input_message %}
                    <div class="space-y-4">
                        <!-- Message Content -->
                        <div class="bg-base-50 rounded-lg p-4 border border-base-200">
                            <div class="prose max-w-none text-sm">
                                {% if trace.input_message.content %}
                                    {{ trace.input_message.content|render_markdown }}
                                {% else %}
                                    <span class="text-base-content/50 italic">No content available</span>
                                {% endif %}
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-base-content/50">
                                    <time datetime="{{ trace.input_message.created_at.isoformat }}" title="{{ trace.input_message.created_at.isoformat }}">
                                      {{ trace.input_message.created_at|date:"DATETIME_FORMAT" }}
                                    </time>
                                </span>
                            </div>
                        </div>

                        <!-- Tags -->
                        {% if trace.input_message.all_tag_names %}
                            <div class="flex flex-wrap gap-1 items-center">
                                <i class="fa-solid fa-tags text-base-content/50 mr-1"></i>
                                {% for tag in trace.input_message.non_skipped_tags %}
                                    <div class="badge {% if tag.is_system_tag %}badge-warning{% else %}badge-neutral{% endif %}">{{ tag.name }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Attachments -->
                        {% with input_attachments=trace.input_message.get_attached_files %}
                        {% if input_attachments %}
                            <div class="border-t border-base-200 pt-3">
                                <div class="text-sm font-medium text-base-content/70 mb-2">
                                    <i class="fa-solid fa-paperclip mr-1"></i> Attachments
                                </div>
                                <div class="flex flex-col gap-2">
                                    {% for file in input_attachments %}
                                        <div class="flex items-center gap-2 text-sm">
                                            {% if file.is_image %}
                                                <i class="fa-solid fa-image text-base-content/50"></i>
                                            {% elif file.is_audio %}
                                                <i class="fa-solid fa-volume-high text-base-content/50"></i>
                                            {% else %}
                                                <i class="fa-solid fa-file text-base-content/50"></i>
                                            {% endif %}
                                            <span>{{ file.name }}</span>
                                            <span class="text-base-content/50">({{ file.display_size }})</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <div class="text-base-content/40 mb-2">
                            <i class="fas fa-inbox text-2xl"></i>
                        </div>
                        <p class="text-base-content/60">No input message available for this trace</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Participant Data -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-header border-b border-base-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-base-content">Participant Data</h3>
            </div>
            <div class="card-body p-6">
                {% if trace.participant_data %}
                    <pre class="text-sm overflow-x-auto whitespace-pre-wrap"><code>{{ trace.participant_data|to_json }}</code></pre>
                {% else %}
                    <div class="text-center py-8">
                        <div class="text-base-content/40 mb-2">
                            <i class="fas fa-user text-2xl"></i>
                        </div>
                        <p class="text-base-content/60">No participant data available</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Session Data -->
        <div class="card bg-base-100 shadow-md">
            <div class="card-header border-b border-base-200 px-6 py-4">
                <h3 class="text-lg font-semibold text-base-content">Session Data</h3>
            </div>
            <div class="card-body p-6">
                {% if trace.session_state %}
                    <pre class="text-sm overflow-x-auto whitespace-pre-wrap"><code>{{ trace.session_state|to_json }}</code></pre>
                {% else %}
                    <div class="text-center py-8">
                        <div class="text-base-content/40 mb-2">
                            <i class="fas fa-database text-2xl"></i>
                        </div>
                        <p class="text-base-content/60">No session data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Output Column -->
    <div class="flex flex-col gap-6">
        <div class="card bg-base-100 shadow-md">
            <div class="card-header border-b border-base-200 px-6 py-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-semibold text-base-content">AI Response</h3>
                    {% if trace.output_message %}
                    <div class="flex items-center gap-2">
                        <!-- Langfuse trace link -->
                        {% for trace_info in trace.output_message.trace_info %}
                            {% if trace_info.trace_provider == "langfuse" %}
                                <a href="{{ trace_info.trace_url }}" target="_blank" class="btn btn-sm btn-ghost" title="View on Langfuse">
                                    {% include "svg/langfuse.svg" %}
                                </a>
                            {% endif %}
                        {% endfor %}
                        {% if trace.output_message.get_absolute_url %}
                            <a href="{{ trace.output_message.get_absolute_url }}" class="btn btn-sm btn-ghost" title="View in session">
                                <i class="fa-solid fa-arrow-up-right-from-square"></i>
                            </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-6">
                {% if trace.output_message %}
                    <div class="space-y-4">
                        <!-- Message Content -->
                        <div class="bg-base-50 rounded-lg p-4 border border-base-200">
                            <div class="prose max-w-none text-sm">
                                {% if trace.output_message.content %}
                                    {{ trace.output_message.content|render_markdown }}
                                {% else %}
                                    <span class="text-base-content/50 italic">No content available</span>
                                {% endif %}
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-base-content/50">
                                    <time datetime="{{ trace.output_message.created_at.isoformat }}" title="{{ trace.output_message.created_at.isoformat }}">
                                      {{ trace.output_message.created_at|date:"DATETIME_FORMAT" }}
                                    </time>
                                </span>
                            </div>
                        </div>

                        <!-- Tags -->
                        {% if trace.output_message.all_tag_names %}
                            <div class="flex flex-wrap gap-1 items-center">
                                <i class="fa-solid fa-tags text-base-content/50 mr-1"></i>
                                {% for tag in trace.output_message.non_skipped_tags %}
                                    <div class="badge {% if tag.is_system_tag %}badge-warning{% else %}badge-neutral{% endif %}">{{ tag.name }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Attachments -->
                        {% with output_attachments=trace.output_message.get_attached_files %}
                        {% if output_attachments %}
                            <div class="border-t border-base-200 pt-3">
                                <div class="text-sm font-medium text-base-content/70 mb-2">
                                    <i class="fa-solid fa-paperclip mr-1"></i> Attachments
                                </div>
                                <div class="flex flex-col gap-2">
                                    {% for file in output_attachments %}
                                        <div class="flex items-center gap-2 text-sm">
                                            {% if file.is_image %}
                                                <i class="fa-solid fa-image text-base-content/50"></i>
                                            {% elif file.is_audio %}
                                                <i class="fa-solid fa-volume-high text-base-content/50"></i>
                                            {% else %}
                                                <i class="fa-solid fa-file text-base-content/50"></i>
                                            {% endif %}
                                            <span>{{ file.name }}</span>
                                            <span class="text-base-content/50">({{ file.display_size }})</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <div class="text-base-content/40 mb-2">
                            <i class="fas fa-reply text-2xl"></i>
                        </div>
                        <p class="text-base-content/60">No output message available for this trace</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
