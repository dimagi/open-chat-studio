{% load waffle_tags %}
{% with table_type=table_type|default:"sessions" %}
<div class="my-3">
  <div class="relative">
    <div class="flex items-center justify-between w-full">
      <div class="flex items-center gap-1">
        <button class="btn btn-ghost btn-sm"
                hx-get="{% url 'chatbots:sessions-list' request.team.slug experiment.id %}"
                hx-target="#sessions-table"
                hx-swap="innerHTML"
                hx-indicator="#refresh-loader"
                hx-disabled-elt="this"
                title="Refresh sessions">
          <i class="fa-solid fa-rotate htmx-hide"></i>
        </button>
        <span class="loading loading-spinner loading-sm htmx-indicator htmx-show" id="refresh-loader"></span>
        
        {% if perms.experiments.download_chats %}
          {% include "experiments/components/exports.html" %}
        {% endif %}
         {% flag "flag_session-analysis" %}
          <a href="{% url 'analysis:create' team.slug experiment.id %}" class="btn btn-sm btn-outline btn-primary">
              <i class="fa-solid fa-table-list"></i> Analyze Transcripts
          </a>
        {% endflag %}
        {% include "experiments/filters.html" %}
      </div>
      
      <div class="ml-4">
        {% include "chatbots/table_actions_dropdown.html" %}
      </div>
    </div>
  </div>
</div>

<!-- Include saved filters dialog -->
{% include "filters/saved_filters_dialog.html" with table_type=table_type %}

<script>
    document.addEventListener('alpine:init', () => {
      if (!Alpine.store('savedFilters{{ table_type|default:"sessions"|title }}')) {
        Alpine.store('savedFilters{{ table_type|default:"sessions"|title }}', {
          tableType: '{{ table_type|default:"sessions" }}',
          items: [],
          newName: '',
          async load() {
            try {
              const url = '{% url "experiments:list_filter_set" request.team.slug table_type %}';
              const res = await fetch(url, { credentials: 'same-origin' });
              const data = await res.json();
              this.items = data.results || [];
            } catch (e) { console.error('Failed to load filter sets', e); }
          },
          createNew() {
            this.newName = '';
            document.getElementById('saveFilterDialog')?.showModal();
          },
          currentFilterParamsFromURL() {
            const params = new URLSearchParams(window.location.search);
            const obj = {};
            params.forEach((value, key) => { if (key.startsWith('filter_')) obj[key] = value; });
            return obj;
          },
          async submitCreate() {
            const payload = {
              name: this.newName,
              filter_params: this.currentFilterParamsFromURL(),
            };
            try {
              const url = '{% url "experiments:create_filter_set" request.team.slug table_type %}';
              const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': SiteJS.app.Cookies.get('csrftoken') },
                credentials: 'same-origin',
                body: JSON.stringify(payload)
              });
              if (!res.ok) {
                const errText = await res.text();
                console.error('Save filter failed', res.status, errText);
                throw new Error('Failed to save filter set');
              }
              await this.load();
              document.getElementById('saveFilterDialog')?.close();
            } catch (e) { console.error(e); }
          },
        });
        // Initial load
        Alpine.store('savedFilters{{ table_type|default:"sessions"|title }}').load();
      }
    });
</script>
{% endwith %}
