{% load form_tags %}
{% if save_successful %}
  {% include "chatbots/partials/channel_buttons_oob.html" %}
{% endif %}
<dialog class="modal" open>
  <div class="modal-box">
    <h3 class="font-bold text-lg">
      {% if channel %}
        Edit {{ channel.platform_enum.label }} Channel
      {% else %}
        Link with {{ platform.label }}
      {% endif %}
    </h3>
    <form method="post"
      {% if channel %}
        hx-post="{% url "channels:channel_edit_dialog" request.team.slug experiment.id channel.id %}?origin={{ request.GET.origin|default:'chatbots' }}"
      {% else %}
        hx-post="{% url "channels:channel_create_dialog" request.team.slug experiment.id platform.value %}?origin={{ request.GET.origin|default:'chatbots' }}"
      {% endif %}
      hx-target="#channel_create_edit_modal_placeholder"
      hx-disabled-elt="input, select, button"
      hx-swap="innerHTML"
    >
      {% csrf_token %}
      {{ form.non_field_errors }}
      {% if extra_form %}{{ extra_form.non_field_errors }}{% endif %}
      {% render_form_fields form %}
      {% if extra_form %}
        <div {% include "generic/attrs.html" with attrs=extra_form.form_attrs %}>
          {% render_form_fields extra_form %}
        </div>
      {% endif %}
      {% if success_message and not embed_code %}
        <div role="alert" class="alert alert-success">
          <span>{{ success_message }}</span>
        </div>
      {% endif %}
      {% if warning_message %}
        <div role="alert" class="alert alert-warning">
          <span>{{ warning_message }}</span>
        </div>
      {% endif %}
      <div class="modal-action">
        <span class="loading loading-spinner loading-sm p-3 ml-4 htmx-indicator"></span>
        {% if channel %}
          <button class="btn btn-primary" type="submit">Update</button>
          <button class="btn btn-error"
                  hx-post="{% url 'channels:delete_channel' request.team.slug experiment.id channel.id %}?origin={{ request.GET.origin|default:'chatbots' }}"
                  hx-target="#channel_create_edit_modal_placeholder"
                  hx-disabled-elt="input, select, button"
                  hx-swap="innerHTML"
          >Delete</button>
        {% else %}
          <button class="btn btn-primary" type="submit">Create</button>
        {% endif %}
        <form method="dialog">
          <button class="btn">Close</button>
        </form>
      </div>
    </form>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button>close</button>
  </form>
</dialog>
{% if embed_code and widget_token %}
    <dialog id="embedded_widget_success_modal" class="modal" x-data="{ autoShow: true }" x-init="if (autoShow) $el.showModal()">
      <div class="modal-box max-w-4xl">
        <h3 class="font-bold text-lg text-success mb-4">
          <i class="fa-solid fa-check-circle me-2"></i>
          Embedded Chat Widget Created Successfully!
        </h3>

        {% with success_data=request.session.embedded_widget_success %}
        <div class="card bg-base-200 mb-4">
          <div class="card-body">
            <h2 class="card-title text-base">
              <i class="fa-solid fa-key me-1"></i>
              Widget Authentication Token
            </h2>
            <div class="join w-full">
              <input type="text" class="input input-bordered join-item flex-1 font-mono text-sm"
                     id="widget-token-copy" value="{{ success_data.widget_token }}" readonly>
              <button class="btn btn-outline join-item" type="button"
                      onclick="SiteJS.app.copyToClipboard(this, 'widget-token-copy')"
                      title="Copy token to clipboard">
                  <i class="fa-solid fa-copy"></i> Copy
              </button>
            </div>
            <div class="text-sm text-warning mt-2">
              <i class="fa-solid fa-shield-alt me-1"></i>
              This token authenticates your widget. Keep it secure and don't share it publicly.
            </div>
          </div>
        </div>

        <div class="card bg-base-200 mb-4">
          <div class="card-body">
            <h2 class="card-title text-base">
              <i class="fa-solid fa-globe me-1"></i>
              Allowed Domains
            </h2>
            {% if success_data.allowed_domains %}
              <ul class="list-none space-y-1">
              {% for domain in success_data.allowed_domains %}
                <li class="flex items-center">
                  <i class="fa-solid fa-check text-success me-2"></i>
                  <span class="font-mono">{{ domain }}</span>
                </li>
              {% endfor %}
              </ul>
            {% else %}
              <div class="alert alert-warning">
                <i class="fa-solid fa-exclamation-triangle"></i>
                <span><strong>All domains allowed</strong> - Consider restricting to specific domains for security.</span>
              </div>
            {% endif %}
            <div class="text-sm opacity-70 mt-2">
              The widget will only work on these authorized domains.
            </div>
          </div>
        </div>

        <div class="card bg-base-200 mb-4">
          <div class="card-body">
            <div class="flex justify-between items-center mb-3">
              <h4 class="card-title text-base mb-0">
                <i class="fa-solid fa-code me-1"></i>
                Embed Code
              </h4>
              <button class="btn btn-sm btn-outline" type="button"
                      onclick="SiteJS.app.copyToClipboard(this, 'embed-code-display')"
                      title="Copy embed code to clipboard">
                  <i class="fa-solid fa-copy"></i> Copy All Code
              </button>
            </div>
            <div class="mockup-code">
              <pre id="embed-code-display" class="text-sm overflow-x-auto">{{ success_data.embed_code }}</pre>
            </div>
            <div class="text-sm opacity-70 mt-2">
              <i class="fa-solid fa-info-circle me-1"></i>
              Copy this code and paste it into your website's HTML where you want the chat widget to appear.
            </div>
          </div>
        </div>
        {% endwith %}

        <div class="modal-action">
          <button class="btn btn-primary" type="button" onclick="closeSuccessModal()">
            <i class="fa-solid fa-check me-1"></i>
            Got it!
          </button>
        </div>
      </div>
    </dialog>

    <script>
      async function clearSessionData() {
        try {
          await fetch("{% url 'channels:clear_widget_success' request.team.slug experiment.id %}", {
            method: 'POST',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
              'Content-Type': 'application/json',
            }
          });
        } catch (error) {
          console.warn('Failed to clear session data:', error);
        }
      }

      function closeSuccessModal() {
        document.getElementById('embedded_widget_success_modal').close();
        clearSessionData();
      }

      clearSessionData();
    </script>
  {% endif %}
