{% extends "web/app/app_base.html" %}

{% block breadcrumbs %}
  <div class="text-sm breadcrumbs" aria-label="breadcrumbs">
    <ul>
      <li><a href="{% url 'human_annotations:queue_home' request.team.slug %}">Annotation Queues</a></li>
      <li class="pg-breadcrumb-active" aria-current="page">{{ object.name }}</li>
    </ul>
  </div>
{% endblock breadcrumbs %}

{% block app %}
<div class="flex flex-col gap-4">
  <div class="flex justify-between items-center">
    <div>
      <h2 class="text-xl font-bold">{{ object.name }}</h2>
      {% if object.description %}
        <p class="text-gray-500">{{ object.description }}</p>
      {% endif %}
    </div>
    <span class="badge badge-outline">{{ object.get_status_display }}</span>
  </div>

  <div class="flex flex-wrap gap-2">
    <a href="{% url 'human_annotations:annotate_queue' team_slug=request.team.slug pk=object.pk %}"
       class="btn btn-primary btn-sm">Start Annotating</a>
    <a href="{% url 'human_annotations:queue_add_sessions' team_slug=request.team.slug pk=object.pk %}"
       class="btn btn-outline btn-sm">Add Sessions</a>
    <a href="{% url 'human_annotations:queue_export' team_slug=request.team.slug pk=object.pk %}?format=csv"
       class="btn btn-outline btn-sm">Export CSV</a>
    <a href="{% url 'human_annotations:queue_export' team_slug=request.team.slug pk=object.pk %}?format=jsonl"
       class="btn btn-outline btn-sm">Export JSONL</a>
    <a href="{% url 'human_annotations:queue_manage_assignees' team_slug=request.team.slug pk=object.pk %}"
       class="btn btn-outline btn-sm">Manage Assignees</a>
  </div>

  <div class="card bg-base-100 shadow-sm">
    <div class="card-body">
      <h3 class="card-title text-sm">Progress</h3>
      <progress class="progress progress-primary w-full" value="{{ progress.percent }}" max="100"></progress>
      <div class="flex flex-wrap gap-x-4 gap-y-1 text-sm text-gray-500 mt-1">
        <span>{{ progress.reviews_done }}/{{ progress.total_reviews_needed }} reviews ({{ progress.percent }}%)</span>
        <span>{{ progress.completed_items }}/{{ progress.total_items }} items completed</span>
        {% if progress.flagged_items %}
          <span class="text-warning">{{ progress.flagged_items }} flagged</span>
        {% endif %}
      </div>
    </div>
  </div>

  {% if aggregates %}
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body">
      <h3 class="card-title text-sm">Aggregate Scores</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mt-2">
        {% for field_name, stats in aggregates.items %}
          <div class="border border-base-300 rounded-lg p-3">
            <div class="flex justify-between items-center mb-2">
              <span class="font-medium">{{ field_name }}</span>
              <span class="text-xs text-base-content/60">n={{ stats.count }}</span>
            </div>
            {% if stats.type == "numeric" %}
              <div class="grid grid-cols-2 gap-1 text-sm">
                <div>mean: <span class="font-mono">{{ stats.mean }}</span></div>
                <div>median: <span class="font-mono">{{ stats.median }}</span></div>
                <div>min: <span class="font-mono">{{ stats.min }}</span></div>
                <div>max: <span class="font-mono">{{ stats.max }}</span></div>
              </div>
            {% elif stats.type == "categorical" %}
              <div class="text-sm mb-1">mode: <span class="font-medium">{{ stats.mode }}</span></div>
              <div class="flex flex-wrap gap-1">
                {% for value, pct in stats.distribution.items %}
                  <span class="badge badge-sm badge-outline">{{ value }}: {{ pct }}%</span>
                {% endfor %}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>
    </div>
  </div>
  {% endif %}

  <div class="card bg-base-100 shadow-sm">
    <div class="card-body">
      <h3 class="card-title text-sm">Assignees</h3>
      <div class="flex flex-wrap gap-2">
        {% for user in object.assignees.all %}
          <span class="badge badge-neutral">{{ user.get_full_name|default:user.username }}</span>
        {% empty %}
          <span class="text-gray-400 text-sm">No assignees</span>
        {% endfor %}
      </div>
    </div>
  </div>

  <div class="card bg-base-100 shadow-sm">
    <div class="card-body">
      <h3 class="card-title text-sm">Items</h3>
      <div id="items-table"
           hx-get="{{ items_table_url }}"
           hx-trigger="load"
           hx-swap="innerHTML">
        <span class="loading loading-spinner loading-md"></span>
      </div>
    </div>
  </div>
</div>
{% endblock app %}
