<div x-data="dateRangeDropdown" x-init="init" class="dropdown">
  <div tabindex="0" role="button" class="btn btn-ghost btn-sm normal-case">
    <i class="fa-regular fa-clock"></i>
    <span x-text="selectedLabel || 'Date Range'" class="dropdown-label"></span>
    <i class="fa-solid fa-caret-down ml-1"></i>
  </div>
  <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
    <template x-for="option in options" :key="option.value">
      <li>
        <a href="#"
           x-text="option.label"
           @click.prevent="selectedLabel = option.label;
                           localStorage.setItem('selected_date_range', option.value);
                           applyDateFilter(option.value);">
        </a>
      </li>
    </template>
  </ul>
</div>

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('dateRangeDropdown', () => ({
      options: [
        { label: 'Last 1 Hour', value: '1h' },
        { label: 'Last 1 Day', value: '1d' },
        { label: 'Last 7 Days', value: '7d' },
        { label: 'Last 15 Days', value: '15d' },
        { label: 'Last 30 Days', value: '30d' },
      ],
      selectedLabel: '',

      init() {
        const url = new URL(window.location.href);
        const params = url.searchParams;

        let hasValidFilter = false;

        for (const [key, val] of params.entries()) {
          if (key.includes('_column') && val === 'last_message') {
            const match = key.match(/filter_(\d+)_column/);
            if (match) {
              const op = params.get(`filter_${match[1]}_operator`);
              if (op === 'range') {
                hasValidFilter = true;
                break;
              }
            }
          }
        }

        if (hasValidFilter) {
          const stored = localStorage.getItem('selected_date_range');
          if (stored) {
            const found = this.options.find(opt => opt.value === stored);
            if (found) {
              this.selectedLabel = found.label;
            }
          }
        } else {
          localStorage.removeItem('selected_date_range');
        }
      },

      applyDateFilter(value) {
        const url = new URL(window.location.href);
        const params = url.searchParams;
        let matchedIndex = null;

        for (const [key, val] of params.entries()) {
          if (key.includes('_column') && val === 'last_message') {
            const match = key.match(/filter_(\d+)_column/);
            if (match) {
              matchedIndex = match[1];
              break;
            }
          }
        }

        if (matchedIndex !== null) {
          const operatorKey = `filter_${matchedIndex}_operator`;
          if (params.get(operatorKey) === 'range') {
            params.set(`filter_${matchedIndex}_value`, value);
            localStorage.setItem('selected_date_range', value);
          } else {
            params.delete(`filter_${matchedIndex}_column`);
            params.delete(operatorKey);
            params.delete(`filter_${matchedIndex}_value`);
            localStorage.removeItem('selected_date_range');
          }
        } else {
          let maxIndex = -1;
          for (const key of params.keys()) {
            const match = key.match(/^filter_(\d+)_column$/);
            if (match) maxIndex = Math.max(maxIndex, parseInt(match[1]));
          }

          const nextIndex = maxIndex + 1;
          params.set(`filter_${nextIndex}_column`, 'last_message');
          params.set(`filter_${nextIndex}_operator`, 'range');
          params.set(`filter_${nextIndex}_value`, value);
          localStorage.setItem('selected_date_range', value);
        }

        url.search = params.toString();
        window.location.href = url.toString();
      }
    }));
  });
</script>
