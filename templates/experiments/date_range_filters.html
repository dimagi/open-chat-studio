<div x-data="dateRangeDropdown" x-init="init" class="dropdown">
  <div tabindex="0" role="button" class="btn btn-ghost btn-sm normal-case">
    <i class="fa-regular fa-clock"></i>
    <span x-text="selectedLabel || 'Date Range'" class="dropdown-label"></span>
    <i class="fa-solid fa-caret-down ml-1"></i>
  </div>
  <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52">
    <template x-for="option in options" :key="option.value">
      <li>
        <a href="#" x-text="option.label" @click.prevent="selectOption(option)"></a>
      </li>
    </template>
  </ul>
</div>
{{ date_range_options|json_script:"date-range-options" }}

<script>
  document.addEventListener('alpine:init', () => {
    Alpine.data('dateRangeDropdown', () => ({
      options: JSON.parse(document.getElementById('date-range-options').textContent),
      selectedLabel: '',

      init() {
        const url = new URL(window.location.href);
        const params = url.searchParams;
        const matchedIndex = this.getLastMessageFilterIndex(params);
        if (matchedIndex !== null) {
          const filterValue = params.get(`filter_${matchedIndex}_value`);
          const found = this.options.find(opt => opt.value === filterValue);
          if (found) {
            this.selectedLabel = found.label;
          } else {
            this.selectedLabel = '';
          }
        } else {
          this.selectedLabel = '';
        }
      },

      selectOption(option) {
        this.selectedLabel = option.label;
        this.updateUrlParams(option.value);
      },

      updateUrlParams(value) {
        const url = new URL(window.location.href);
        const params = url.searchParams;
        const matchedIndex = this.getLastMessageFilterIndex(params);
        if (matchedIndex !== null) {
          params.set(`filter_${matchedIndex}_operator`, 'range');
          params.set(`filter_${matchedIndex}_value`, value);
        } else {
          let maxIndex = -1;
          for (const key of params.keys()) {
            const match = key.match(/^filter_(\d+)_column$/);
            if (match) maxIndex = Math.max(maxIndex, parseInt(match[1]));
          }
          const nextIndex = maxIndex + 1;
          params.set(`filter_${nextIndex}_column`, 'last_message');
          params.set(`filter_${nextIndex}_operator`, 'range');
          params.set(`filter_${nextIndex}_value`, value);
        }
        url.search = params.toString();
        window.location.href = url.toString();
      },

      getLastMessageFilterIndex(params) {
        for (const [key, val] of params.entries()) {
          if (key.includes('_column') && val === 'last_message') {
            const match = key.match(/filter_(\d+)_column/);
            if (match) {
              return match[1];
            }
          }
        }
        return null;
      }
    }));
  });
</script>