# Generated by Django 5.1.5 on 2025-09-25 13:11

from django.db import migrations, models

def _move_traces_to_working_version(apps, schema_editor):
    """Move existing traces to the working version of their experiments, if applicable."""
    Trace = apps.get_model("trace", "Trace")
    # Find all traces linked to experiment versions
    queryset = Trace.objects.filter(experiment__working_version__isnull=False).select_related("experiment")
    traces = []
    for trace in queryset.iterator(chunk_size=500):
        experiment_version = trace.experiment
        if experiment_version.working_version_id is None:
            # sanity check
            continue

        trace.experiment_id = experiment_version.working_version_id
        trace.experiment_version_number = experiment_version.version_number
        traces.append(trace)
        if len(traces) >= 500:
            Trace.objects.bulk_update(traces, fields=["experiment_id", "experiment_version_number"])
            traces = []

    # Final bulk update for any remaining traces
    Trace.objects.bulk_update(traces, fields=["experiment_id", "experiment_version_number"])


class Migration(migrations.Migration):

    dependencies = [
        ('trace', '0004_trace_participant_data_trace_session_state_and_more'),
    ]

    operations = [
        migrations.AddField(
            model_name='trace',
            name='experiment_version_number',
            field=models.PositiveIntegerField(blank=True, null=True),
        ),
        migrations.RunPython(_move_traces_to_working_version, reverse_code=migrations.RunPython.noop),
    ]
