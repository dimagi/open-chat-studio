# Generated by Django 4.2.11 on 2024-07-18 07:56

from django.db import migrations, models
from django.db.models import OuterRef, Subquery, Value
from django.db.models.functions import Coalesce


def set_participant_platform(apps, schema_editor):
    Participant = apps.get_model("experiments", "Participant")
    ExperimentSession = apps.get_model("experiments", "ExperimentSession")
    Participant.objects.update(
        platform=Coalesce(
            Subquery(
                ExperimentSession.objects
                .exclude(experiment_channel=None)
                .filter(participant_id=OuterRef('id'))
                .values('experiment_channel__platform')[:1]
            ),
            Value("")
        )
    )


class Migration(migrations.Migration):
    dependencies = [
        ("ocs_channels", "0017_alter_experimentchannel_platform"),
        ("experiments", "0083_remove_experiment_no_activity_config_and_more"),
        ("teams", "0006_remove_invitation_role_remove_membership_role"),
    ]

    operations = [
        migrations.AddField(
            model_name="participant",
            name="platform",
            field=models.CharField(default="", max_length=32),
            preserve_default=False,
        ),
        migrations.RunPython(set_participant_platform, migrations.RunPython.noop, elidable=True),
        migrations.AlterModelOptions(
            name="participant",
            options={"ordering": ["platform", "identifier"]},
        ),
        migrations.AlterUniqueTogether(
            name="participant",
            unique_together={("team", "platform", "identifier")},
        ),
    ]
