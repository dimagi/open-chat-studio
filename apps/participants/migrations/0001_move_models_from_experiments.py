# Generated by Django 5.1.5 on 2025-11-24 21:29

import apps.participants.models
import apps.utils.fields
import apps.utils.models
import django.db.models.deletion
import django_cryptography.fields
import uuid
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):
    """
    Move Participant and ParticipantData models from experiments app to participants app.
    This uses SeparateDatabaseAndState to tell Django the models have moved without
    changing the actual database tables (they keep their experiments_ prefixed names).
    """

    initial = True

    dependencies = [
        ('experiments', '0119_experimentsession_experiment_versions_and_more'),
        ('teams', '0007_create_commcare_connect_flag'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            state_operations=[
                # Tell Django these models exist in the participants app
                migrations.CreateModel(
                    name='Participant',
                    fields=[
                        ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                        ('created_at', models.DateTimeField(auto_now_add=True)),
                        ('updated_at', models.DateTimeField(auto_now=True)),
                        ('name', models.CharField(blank=True, max_length=320)),
                        ('identifier', models.CharField(blank=True, max_length=320)),
                        ('public_id', models.UUIDField(default=uuid.uuid4, unique=True)),
                        ('platform', models.CharField(max_length=32)),
                        ('remote_id', models.CharField(blank=True, default='', max_length=255)),
                        ('team', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='teams.team', verbose_name='Team')),
                        ('user', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
                    ],
                    options={
                        'db_table': 'experiments_participant',
                        'ordering': ['platform', 'identifier'],
                        'unique_together': {('team', 'platform', 'identifier')},
                    },
                    bases=(models.Model, apps.utils.models.VersioningMixin),
                ),
                migrations.CreateModel(
                    name='ParticipantData',
                    fields=[
                        ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                        ('created_at', models.DateTimeField(auto_now_add=True)),
                        ('updated_at', models.DateTimeField(auto_now=True)),
                        ('data', django_cryptography.fields.encrypt(apps.utils.fields.SanitizedJSONField(default=dict, validators=[apps.participants.models.validate_json_dict]))),
                        ('system_metadata', apps.utils.fields.SanitizedJSONField(default=dict)),
                        ('encryption_key', django_cryptography.fields.encrypt(models.CharField(blank=True, help_text='The base64 encoded encryption key', max_length=255))),
                        ('experiment', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='experiments.experiment')),
                        ('participant', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='data_set', to='participants.participant')),
                        ('team', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='teams.team', verbose_name='Team')),
                    ],
                    options={
                        'db_table': 'experiments_participantdata',
                        'indexes': [models.Index(fields=['experiment'], name='experiments_experim_70f029_idx')],
                        'unique_together': {('participant', 'experiment')},
                    },
                    bases=(models.Model, apps.utils.models.VersioningMixin),
                ),
            ],
            # No database operations needed for forward migration - tables already exist
            # For reverse, also no database operations - we just update Django's state
            database_operations=[],
        ),
    ]
    
    # Note: This migration is reversible but requires coordination with experiments.0121
    # Rolling back will move the model definitions back to experiments app without touching the database
