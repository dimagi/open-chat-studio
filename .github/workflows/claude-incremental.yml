name: Claude Incremental Worker

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2am UTC
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Specific issue number to work on (optional)'
        required: false
        type: string

jobs:
  check-pending-pr:
    runs-on: ubuntu-latest
    outputs:
      has_open_pr: ${{ steps.check.outputs.has_open_pr }}
      pr_number: ${{ steps.check.outputs.pr_number }}
    steps:
      - name: Check for open PRs with label
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR=$(gh pr list --repo ${{ github.repository }} --label "claude-incremental" --state open --json number --jq '.[0].number // empty')
          if [ -n "$PR" ]; then
            echo "has_open_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR" >> $GITHUB_OUTPUT
            echo "::notice::Waiting for PR #$PR to be reviewed"
          else
            echo "has_open_pr=false" >> $GITHUB_OUTPUT
          fi

  find-work:
    needs: check-pending-pr
    if: needs.check-pending-pr.outputs.has_open_pr != 'true'
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.find.outputs.issue_number }}
      issue_body: ${{ steps.find.outputs.issue_body }}
      issue_title: ${{ steps.find.outputs.issue_title }}
    steps:
      - name: Find oldest labeled issue in progress
        id: find
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Use specific issue if provided, otherwise find oldest in "In Progress" status
          if [ -n "${{ inputs.issue_number }}" ]; then
            ISSUE_NUMBER="${{ inputs.issue_number }}"
          else
            # Query the GitHub Project to find issues with claude-incremental label
            # that are in "In Progress" status
            # Project: https://github.com/orgs/dimagi/projects/3
            QUERY='
            query($org: String!, $projectNumber: Int!) {
              organization(login: $org) {
                projectV2(number: $projectNumber) {
                  items(first: 100) {
                    nodes {
                      fieldValueByName(name: "Status") {
                        ... on ProjectV2ItemFieldSingleSelectValue {
                          name
                        }
                      }
                      content {
                        ... on Issue {
                          number
                          state
                          createdAt
                          labels(first: 10) {
                            nodes {
                              name
                            }
                          }
                          repository {
                            nameWithOwner
                          }
                        }
                      }
                    }
                  }
                }
              }
            }'

            RESULT=$(gh api graphql -f query="$QUERY" -f org="dimagi" -F projectNumber=3)

            # Find the oldest issue that:
            # 1. Is in this repository
            # 2. Has the claude-incremental label
            # 3. Is in "In Progress" status
            # 4. Is open
            ISSUE_NUMBER=$(echo "$RESULT" | jq -r '
              .data.organization.projectV2.items.nodes
              | map(select(
                  .content.repository.nameWithOwner == "${{ github.repository }}"
                  and .content.state == "OPEN"
                  and .fieldValueByName.name == "In Progress"
                  and (.content.labels.nodes | map(.name) | contains(["claude-incremental"]))
                ))
              | sort_by(.content.createdAt)
              | .[0].content.number // empty
            ')
          fi

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "::notice::No active projects found (no issues with claude-incremental label in 'In Progress' status)"
            exit 0
          fi

          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

          # Fetch issue details
          ISSUE_DATA=$(gh issue view "$ISSUE_NUMBER" --repo ${{ github.repository }} --json title,body)
          ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
          ISSUE_BODY=$(echo "$ISSUE_DATA" | jq -r '.body')

          echo "issue_title<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "issue_body<<EOF" >> $GITHUB_OUTPUT
          echo "$ISSUE_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  execute:
    needs: find-work
    if: needs.find-work.outputs.issue_number != ''
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create branch
        id: branch
        run: |
          BRANCH_NAME="claude-incremental/${{ needs.find-work.outputs.issue_number }}-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            You are working on an incremental project tracked in issue #${{ needs.find-work.outputs.issue_number }}.

            ## Issue Title
            ${{ needs.find-work.outputs.issue_title }}

            ## Issue Content
            ${{ needs.find-work.outputs.issue_body }}

            ## Instructions
            1. Read the issue and identify the first unchecked task (- [ ]) that is not marked as blocked
            2. Implement that task
            3. Run lint and tests, fix any issues:
               - Python: ruff check --fix && ruff format
               - JS/TS: npm run lint
            4. After completing the task, update the issue using gh issue edit to:
               - Check off the completed task (change - [ ] to - [x])
               - Add any learnings to the ## Learnings section (create if needed)
            5. If you cannot complete the task, mark it as blocked (add "blocked:" prefix to the task)
            6. Add a comment to the issue summarizing what you did

            If all tasks are complete or blocked, comment on the issue explaining the status.
          allowed_tools: |
            Bash(npm run lint:*),Bash(npm run type-check:*),Bash(ruff check:*),Bash(ruff format:*),Bash(pytest:*),Bash(git add:*),Bash(git commit:*),Bash(git push:*),Bash(gh issue edit:*),Bash(gh issue comment:*),Read,Write,Edit

      - name: Push changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            git push -u origin ${{ steps.branch.outputs.branch_name }}
          fi

  create-pr:
    needs: [find-work, execute]
    if: needs.find-work.outputs.issue_number != ''
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes and create PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the branch created in the execute step
          BRANCH=$(git branch -r --list "origin/claude-incremental/${{ needs.find-work.outputs.issue_number }}-*" | head -1 | sed 's/origin\///' | xargs)

          if [ -z "$BRANCH" ]; then
            echo "::notice::No branch found, no changes were made"
            exit 0
          fi

          # Check if PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            echo "::notice::PR #$EXISTING_PR already exists for branch $BRANCH"
            exit 0
          fi

          # Create PR
          gh pr create \
            --title "Claude Incremental: Progress on #${{ needs.find-work.outputs.issue_number }}" \
            --body "Automated progress on tracking issue #${{ needs.find-work.outputs.issue_number }}.

            See the issue for task details and learnings.

            ---
            *Created by Claude Incremental Worker*" \
            --head "$BRANCH" \
            --label "claude-incremental" || echo "::warning::Failed to create PR"
